Index: lib/providers/people_provider.dart
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import 'package:flutter/material.dart';\r\nimport 'package:cortex_ai_gallery/models/person.dart';\r\nimport 'package:cortex_ai_gallery/services/api_service.dart';\r\n\r\nclass PeopleProvider with ChangeNotifier {\r\n  final ApiService _apiService;\r\n\r\n  List<Person> _people = [];\r\n  List<Person> get people => _people;\r\n\r\n  bool _isLoading = true;\r\n  bool get isLoading => _isLoading;\r\n\r\n  PeopleProvider(this._apiService) {\r\n    fetchPeople();\r\n  }\r\n\r\n  Future<void> fetchPeople() async {\r\n    _isLoading = true;\r\n    notifyListeners();\r\n\r\n    _people = await _apiService.getPeople();\r\n\r\n    _isLoading = false;\r\n    notifyListeners();\r\n  }\r\n\r\n  // ADDED: A refresh method for programmatic updates\r\n  Future<void> refresh() async {\r\n    // We don't set loading to true here to make the refresh smoother\r\n    _people = await _apiService.getPeople();\r\n    notifyListeners();\r\n  }\r\n\r\n  Future<bool> updatePersonName(String personId, String newName) async {\r\n    final index = _people.indexWhere((p) => p.personId == personId);\r\n    if (index == -1) return false;\r\n\r\n    final oldPerson = _people[index];\r\n    final newPerson = Person(\r\n      personId: oldPerson.personId,\r\n      name: newName,\r\n      faceCount: oldPerson.faceCount,\r\n      coverThumbnailUrl: oldPerson.coverThumbnailUrl,\r\n    );\r\n\r\n    _people[index] = newPerson;\r\n    notifyListeners();\r\n\r\n    final success = await _apiService.updatePersonName(personId, newName);\r\n    if (!success) {\r\n      _people[index] = oldPerson;\r\n      notifyListeners();\r\n    }\r\n    return success;\r\n  }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/lib/providers/people_provider.dart b/lib/providers/people_provider.dart
--- a/lib/providers/people_provider.dart	(revision 2d09ac19855f0d5b145638974fee259157d5235d)
+++ b/lib/providers/people_provider.dart	(date 1756715928342)
@@ -31,27 +31,4 @@
     _people = await _apiService.getPeople();
     notifyListeners();
   }
-
-  Future<bool> updatePersonName(String personId, String newName) async {
-    final index = _people.indexWhere((p) => p.personId == personId);
-    if (index == -1) return false;
-
-    final oldPerson = _people[index];
-    final newPerson = Person(
-      personId: oldPerson.personId,
-      name: newName,
-      faceCount: oldPerson.faceCount,
-      coverThumbnailUrl: oldPerson.coverThumbnailUrl,
-    );
-
-    _people[index] = newPerson;
-    notifyListeners();
-
-    final success = await _apiService.updatePersonName(personId, newName);
-    if (!success) {
-      _people[index] = oldPerson;
-      notifyListeners();
-    }
-    return success;
-  }
 }
\ No newline at end of file
Index: lib/screens/main/people_page.dart
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import 'package:flutter/material.dart';\r\nimport 'package:provider/provider.dart';\r\nimport 'package:cortex_ai_gallery/providers/people_provider.dart';\r\nimport 'package:cortex_ai_gallery/providers/settings_provider.dart';\r\nimport 'package:cortex_ai_gallery/screens/main/person_media_page.dart';\r\nimport 'package:cortex_ai_gallery/widgets/cached_image_widget.dart';\r\n\r\nclass PeoplePage extends StatelessWidget {\r\n  const PeoplePage({super.key});\r\n\r\n  Future<void> _showRenameDialog(\r\n      BuildContext context, Person person, PeopleProvider provider) async {\r\n    final controller = TextEditingController(text: person.name);\r\n    final newName = await showDialog<String>(\r\n      context: context,\r\n      builder: (context) {\r\n        return AlertDialog(\r\n          title: const Text('Rename Person'),\r\n          content: TextField(\r\n            controller: controller,\r\n            autofocus: true,\r\n            decoration: const InputDecoration(hintText: 'Enter new name'),\r\n          ),\r\n          actions: [\r\n            TextButton(\r\n              onPressed: () => Navigator.of(context).pop(),\r\n              child: const Text('Cancel'),\r\n            ),\r\n            TextButton(\r\n              onPressed: () {\r\n                Navigator.of(context).pop(controller.text);\r\n              },\r\n              child: const Text('Save'),\r\n            ),\r\n          ],\r\n        );\r\n      },\r\n    );\r\n\r\n    if (newName != null && newName.isNotEmpty && newName != person.name) {\r\n      final success = await provider.updatePersonName(person.personId, newName);\r\n      if (context.mounted && !success) {\r\n        ScaffoldMessenger.of(context).showSnackBar(\r\n          const SnackBar(content: Text('Failed to update name.')),\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    final settings = Provider.of<SettingsProvider>(context);\r\n    final peopleProvider = Provider.of<PeopleProvider>(context);\r\n\r\n    return Scaffold(\r\n      appBar: AppBar(title: const Text('People')),\r\n      // The Consumer widget will now correctly rebuild when data arrives\r\n      body: Consumer<PeopleProvider>(\r\n        builder: (context, provider, child) {\r\n          if (provider.isLoading) {\r\n            return const Center(child: CircularProgressIndicator());\r\n          }\r\n\r\n          // Wrap the grid in a RefreshIndicator\r\n          return RefreshIndicator(\r\n            onRefresh: () => provider.refresh(),\r\n            child: provider.people.isEmpty\r\n                ? const Center(child: Text('No people found yet.')) // Show message if list is empty\r\n                : GridView.builder(\r\n              padding: const EdgeInsets.all(8.0),\r\n              itemCount: provider.people.length,\r\n              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(\r\n                crossAxisCount: settings.gridSize > 2 ? settings.gridSize - 1 : 2,\r\n                crossAxisSpacing: 8.0,\r\n                mainAxisSpacing: 8.0,\r\n              ),\r\n              itemBuilder: (context, index) {\r\n                final person = provider.people[index];\r\n                return GestureDetector(\r\n                  onTap: () {\r\n                    Navigator.push(\r\n                      context,\r\n                      MaterialPageRoute(\r\n                        builder: (context) => PersonMediaPage(\r\n                          personId: person.personId,\r\n                          personName: person.name,\r\n                        ),\r\n                      ),\r\n                    );\r\n                  },\r\n                  onLongPress: () {\r\n                    _showRenameDialog(context, person, provider);\r\n                  },\r\n                  child: Card(\r\n                    clipBehavior: Clip.antiAlias,\r\n                    child: GridTile(\r\n                      footer: GridTileBar(\r\n                        backgroundColor: Colors.black45,\r\n                        title: Text(person.name),\r\n                        subtitle: Text('${person.faceCount} photos'),\r\n                      ),\r\n                      child:\r\n                          CachedImageWidget(imageUrl: person.coverThumbnailUrl),\r\n                    ),\r\n                  ),\r\n                );\r\n              },\r\n            ),\r\n          );\r\n        },\r\n      ),\r\n    );\r\n  }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/lib/screens/main/people_page.dart b/lib/screens/main/people_page.dart
--- a/lib/screens/main/people_page.dart	(revision 2d09ac19855f0d5b145638974fee259157d5235d)
+++ b/lib/screens/main/people_page.dart	(date 1756715928353)
@@ -8,45 +8,6 @@
 class PeoplePage extends StatelessWidget {
   const PeoplePage({super.key});
 
-  Future<void> _showRenameDialog(
-      BuildContext context, Person person, PeopleProvider provider) async {
-    final controller = TextEditingController(text: person.name);
-    final newName = await showDialog<String>(
-      context: context,
-      builder: (context) {
-        return AlertDialog(
-          title: const Text('Rename Person'),
-          content: TextField(
-            controller: controller,
-            autofocus: true,
-            decoration: const InputDecoration(hintText: 'Enter new name'),
-          ),
-          actions: [
-            TextButton(
-              onPressed: () => Navigator.of(context).pop(),
-              child: const Text('Cancel'),
-            ),
-            TextButton(
-              onPressed: () {
-                Navigator.of(context).pop(controller.text);
-              },
-              child: const Text('Save'),
-            ),
-          ],
-        );
-      },
-    );
-
-    if (newName != null && newName.isNotEmpty && newName != person.name) {
-      final success = await provider.updatePersonName(person.personId, newName);
-      if (context.mounted && !success) {
-        ScaffoldMessenger.of(context).showSnackBar(
-          const SnackBar(content: Text('Failed to update name.')),
-        );
-      }
-    }
-  }
-
   @override
   Widget build(BuildContext context) {
     final settings = Provider.of<SettingsProvider>(context);
@@ -88,9 +49,6 @@
                       ),
                     );
                   },
-                  onLongPress: () {
-                    _showRenameDialog(context, person, provider);
-                  },
                   child: Card(
                     clipBehavior: Clip.antiAlias,
                     child: GridTile(
Index: lib/screens/main/all_media_page.dart
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import 'dart:io';\r\nimport 'package:flutter/material.dart';\r\nimport 'package:provider/provider.dart';\r\nimport 'package:file_picker/file_picker.dart';\r\nimport 'package:crypto/crypto.dart';\r\nimport 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';\r\nimport 'package:cortex_ai_gallery/providers/media_provider.dart';\r\nimport 'package:cortex_ai_gallery/providers/people_provider.dart';\r\nimport 'package:cortex_ai_gallery/providers/settings_provider.dart';\r\nimport 'package:cortex_ai_gallery/screens/main/media_viewer_page.dart';\r\nimport 'package:cortex_ai_gallery/services/api_service.dart';\r\nimport 'package:cortex_ai_gallery/widgets/cached_image_widget.dart';\r\n\r\nclass AllMediaPage extends StatefulWidget {\r\n  const AllMediaPage({super.key});\r\n\r\n  @override\r\n  State<AllMediaPage> createState() => _AllMediaPageState();\r\n}\r\n\r\nclass _AllMediaPageState extends State<AllMediaPage> {\r\n  final ScrollController _scrollController = ScrollController();\r\n  bool _isUploading = false;\r\n\r\n  @override\r\n  void initState() {\r\n    super.initState();\r\n    final mediaProvider = Provider.of<MediaProvider>(context, listen: false);\r\n    _scrollController.addListener(() {\r\n      if (_scrollController.position.pixels >= _scrollController.position.maxScrollExtent - 300) {\r\n        mediaProvider.fetchMedia();\r\n      }\r\n    });\r\n  }\r\n\r\n  Future<String> _calculateHash(File file) async {\r\n    final stream = file.openRead();\r\n    final hash = await sha256.bind(stream).first;\r\n    return hash.toString();\r\n  }\r\n\r\n  Future<void> _pickAndUploadFiles() async {\r\n    setState(() => _isUploading = true);\r\n\r\n    final result = await FilePicker.platform.pickFiles(\r\n      allowMultiple: true,\r\n      type: FileType.media,\r\n    );\r\n\r\n    if (result != null && result.files.isNotEmpty) {\r\n      final apiService = context.read<ApiService>();\r\n      final filesToUpload = result.paths.map((path) => File(path!)).toList();\r\n\r\n      final hashes = await Future.wait(filesToUpload.map((file) => _calculateHash(file)));\r\n      final fileHashMap = {for (var i = 0; i < hashes.length; i++) hashes[i]: filesToUpload[i]};\r\n\r\n      final neededHashes = await apiService.checkHashes(hashes);\r\n      final neededFiles = neededHashes.map((hash) => fileHashMap[hash]!).toList();\r\n\r\n      if (neededFiles.isNotEmpty) {\r\n        final success = await apiService.uploadFiles(neededFiles);\r\n        if (context.mounted) {\r\n          ScaffoldMessenger.of(context).showSnackBar(\r\n            SnackBar(content: Text(success ? '${neededFiles.length} new file(s) uploaded successfully!' : 'Upload failed.')),\r\n          );\r\n\r\n          if (success) {\r\n            await Future.delayed(const Duration(seconds: 2));\r\n            context.read<MediaProvider>().refresh();\r\n            context.read<PeopleProvider>().refresh();\r\n          }\r\n        }\r\n      } else {\r\n        if (context.mounted) {\r\n          ScaffoldMessenger.of(context).showSnackBar(\r\n            const SnackBar(content: Text('All selected files already exist on the server.')),\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (context.mounted) {\r\n      setState(() => _isUploading = false);\r\n    }\r\n  }\r\n\r\n  @override\r\n  void dispose() {\r\n    _scrollController.dispose();\r\n    super.dispose();\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    final settings = Provider.of<SettingsProvider>(context);\r\n\r\n    return Scaffold(\r\n      appBar: AppBar(\r\n        title: const Text('All Media'),\r\n        actions: [\r\n          // CORRECTED: Replaced icon to ensure it renders correctly\r\n          if (_isUploading)\r\n            const Padding(\r\n              padding: EdgeInsets.only(right: 16.0),\r\n              child: Center(child: SizedBox(width: 24, height: 24, child: CircularProgressIndicator(strokeWidth: 3))),\r\n            )\r\n          else\r\n            IconButton(\r\n              icon: const Icon(Icons.upload_file), // Using a standard icon\r\n              tooltip: 'Upload from Gallery',\r\n              onPressed: _pickAndUploadFiles,\r\n            ),\r\n        ],\r\n      ),\r\n      body: Consumer<MediaProvider>(\r\n        builder: (context, provider, child) {\r\n          // ... rest of the file is the same\r\n          if (provider.mediaItems.isEmpty && provider.isLoading) {\r\n            return const Center(child: CircularProgressIndicator());\r\n          }\r\n\r\n          return RefreshIndicator(\r\n            onRefresh: () => provider.refresh(),\r\n            child: MasonryGridView.builder(\r\n              controller: _scrollController,\r\n              padding: const EdgeInsets.all(4.0),\r\n              itemCount: provider.mediaItems.length + (provider.hasMore ? 1 : 0),\r\n              gridDelegate: SliverSimpleGridDelegateWithFixedCrossAxisCount(crossAxisCount: settings.gridSize),\r\n              itemBuilder: (context, index) {\r\n                if (index == provider.mediaItems.length) {\r\n                  return const Center(child: Padding(padding: EdgeInsets.all(16.0), child: CircularProgressIndicator()));\r\n                }\r\n                final item = provider.mediaItems[index];\r\n                return GestureDetector(\r\n                  onTap: () {\r\n                    Navigator.push(\r\n                      context,\r\n                      MaterialPageRoute(\r\n                        builder: (context) => MediaViewerPage(\r\n                          mediaUrl: item.mediaUrl,\r\n                          fileType: item.fileType,\r\n                          heroTag: item.id,\r\n                        ),\r\n                      ),\r\n                    );\r\n                  },\r\n                  child: Card(\r\n                    clipBehavior: Clip.antiAlias,\r\n                    child: Hero(\r\n                      tag: item.id,\r\n                      child: CachedImageWidget(imageUrl: item.thumbnailUrl),\r\n                    ),\r\n                  ),\r\n                );\r\n              },\r\n            ),\r\n          );\r\n        },\r\n      ),\r\n    );\r\n  }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/lib/screens/main/all_media_page.dart b/lib/screens/main/all_media_page.dart
--- a/lib/screens/main/all_media_page.dart	(revision 2d09ac19855f0d5b145638974fee259157d5235d)
+++ b/lib/screens/main/all_media_page.dart	(date 1756715928362)
@@ -7,7 +7,7 @@
 import 'package:cortex_ai_gallery/providers/media_provider.dart';
 import 'package:cortex_ai_gallery/providers/people_provider.dart';
 import 'package:cortex_ai_gallery/providers/settings_provider.dart';
-import 'package:cortex_ai_gallery/screens/main/media_viewer_page.dart';
+import 'package:cortex_ai_gallery/screens/main/photo_view_page.dart';
 import 'package:cortex_ai_gallery/services/api_service.dart';
 import 'package:cortex_ai_gallery/widgets/cached_image_widget.dart';
 
@@ -131,19 +131,18 @@
                   return const Center(child: Padding(padding: EdgeInsets.all(16.0), child: CircularProgressIndicator()));
                 }
                 final item = provider.mediaItems[index];
-                return GestureDetector(
-                  onTap: () {
-                    Navigator.push(
-                      context,
-                      MaterialPageRoute(
-                        builder: (context) => MediaViewerPage(
-                          mediaUrl: item.mediaUrl,
-                          fileType: item.fileType,
-                          heroTag: item.id,
-                        ),
-                      ),
-                    );
-                  },
+                  return GestureDetector(
+                    onTap: () {
+                      Navigator.push(
+                        context,
+                        MaterialPageRoute(
+                          builder: (context) => PhotoViewPage(
+                            imageUrl: item.mediaUrl,
+                            heroTag: item.id,
+                          ),
+                        ),
+                      );
+                    },
                   child: Card(
                     clipBehavior: Clip.antiAlias,
                     child: Hero(
diff --git a/lib/screens/main/photo_view_page.dart b/lib/screens/main/photo_view_page.dart
new file mode 100644
